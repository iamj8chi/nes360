<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>No Están Solos VR - Zet Studios</title>
    <script src="dist\aframe.min.js"></script>
    <script src="dist\aframe-extras.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <a-scene>
      <a-assets>
        <a-asset-item id="cloudModel" src="assets\nube.glb"></a-asset-item>

        <a-asset-item id="samuuModel" src="assets\samuu.glb"></a-asset-item>

        <a-asset-item
          id="flamingoModel"
          src="assets\flamengo.glb"
        ></a-asset-item>

        <a-asset-item id="groundModel" src="assets\ground.glb"></a-asset-item>
      </a-assets>

      <!-- Fade overlay -->
      <a-entity
        id="fadeOverlay"
        geometry="primitive: plane; height: 100; width: 100"
        material="color: black; opacity: 0.0; shader: flat"
        position="0 1.6 -1"
        visible="true"
      ></a-entity>

      <!-- Red clouds to switch to specific scenes -->
      <a-entity
        id="redCloud1"
        class="cloud clickable red-cloud"
        geometry="primitive: sphere; radius: 0.8"
        material="color: red"
        position="-2 4 -10"
      >
        <a-text
          value="Click me"
          align="center"
          position="0 1 0"
          visible="false"
        ></a-text>
      </a-entity>
      <a-entity
        id="redCloud2"
        class="cloud clickable red-cloud"
        geometry="primitive: sphere; radius: 0.8"
        material="color: red"
        position="0 4 -10"
      >
        <a-text
          value="Click me"
          align="center"
          position="0 1 0"
          visible="false"
        ></a-text>
      </a-entity>
      <a-entity
        id="redCloud3"
        class="cloud clickable red-cloud"
        geometry="primitive: sphere; radius: 0.8"
        material="color: red"
        position="2 4 -10"
      >
        <a-text
          value="Click me"
          align="center"
          position="0 1 0"
          visible="false"
        ></a-text>
      </a-entity>

      <!-- Camera Rig -->

      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera
          cursor="rayOrigin: mouse"
          raycaster="objects: .clickable"
        ></a-camera>

        <!-- Left Hand -->

        <a-entity
          laser-controls="hand: left"
          teleport-controls="cameraRig: #cameraRig; collisionEntities: .clickable"
          raycaster="objects: .clickable"
          cursor="fuse: false; rayOrigin: entity"
          id="leftHand"
        >
          <a-entity
            id="leftWing"
            geometry="primitive: box; height: 0.5; width: 0.15; depth: 1"
            material="color: pink"
            position="0 -0.3 0.1"
          ></a-entity>
        </a-entity>

        <!-- Right Hand -->

        <a-entity
          laser-controls="hand: right"
          teleport-controls="cameraRig: #cameraRig; collisionEntities: .clickable"
          raycaster="objects: .clickable"
          cursor="fuse: false; rayOrigin: entity"
          id="rightHand"
        >
          <a-entity
            id="rightWing"
            geometry="primitive: box; height: 0.5; width: 0.15; depth: 1"
            material="color: pink"
            position="0 -0.3 0.1"
          ></a-entity>
        </a-entity>
      </a-entity>
    </a-scene>

    <!-- Scene Templates -->

    <!-- Scene #1 - Intro-->>

    <template id="scene1">
      <a-entity>
        <!-- Skybox con textura personalizada -->
        <a-sky src="assets/skybox.png"></a-sky>

        <!-- Ocean -->
        <a-ocean
          width="50"
          depth="50"
          density="40"
          opacity="1"
          position="0 0 0"
        ></a-ocean>

        <!-- White Clouds -->

        <a-entity
          class="cloud clickable"
          gltf-model="#cloudModel"
          position="-10 2 -15"
          scale="1 1 1"
          rotation="0 180 0"
        >
          <a-text
            value="Click me"
            align="center"
            position="0 1 0"
            visible="false"
          ></a-text>
        </a-entity>

        <a-entity
          class="cloud clickable"
          gltf-model="#cloudModel"
          position="4 4 -18"
          scale="1 1 1"
          rotation="0 45 0"
        >
          <a-text
            value="Click me"
            align="center"
            position="0 1 0"
            visible="false"
          ></a-text>
        </a-entity>

        <a-entity
          class="cloud clickable"
          gltf-model="#cloudModel"
          position="8 3 -22"
          scale="1 1 1"
          rotation="0 90 0"
        >
          <a-text
            value="Click me"
            align="center"
            position="0 1 0"
            visible="false"
          ></a-text>
        </a-entity>

        <!-- Flamingos -->
        <a-entity
          gltf-model="#flamingoModel"
          position="-15 3 -10"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 500; easing: easeInOutSine; loop: true; to: -15 2.5 -10"
          animation-mixer="clip: fly-loop; timeScale: 1.5"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="-10 3 -13"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 1000; easing: easeInOutSine; loop: true; to: -10 2.5 -13"
          animation-mixer="clip: fly-loop; timeScale: 1.4"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="-5 3 -16"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 2000; easing: easeInOutSine; loop: true; to: -5 2.5 -16"
          animation-mixer="clip: fly-loop; timeScale: 1.5"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="0 3 -20"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 0; easing: easeInOutSine; loop: true; to: 0 2.5 -20"
          animation-mixer="clip: fly-loop; timeScale: 1.8"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="5 3 -16"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 200; easing: easeInOutSine; loop: true; to: 5 2.5 -16"
          animation-mixer="clip: fly-loop; timeScale: 1.4"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="10 3 -13"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 300; easing: easeInOutSine; loop: true; to: 10 2.5 -13"
          animation-mixer="clip: fly-loop; timeScale: 1.5"
        >
        </a-entity>

        <a-entity
          gltf-model="#flamingoModel"
          position="15 3 -10"
          scale="3 3 3"
          animation="property: position; dir: alternate; dur: 2000; delay: 800; easing: easeInOutSine; loop: true; to: 15 2.5 -10"
          animation-mixer="clip: fly-loop; timeScale: 1.7"
        >
        </a-entity>

        <!-- Animated Ground -->
        <a-entity
          gltf-model="#groundModel"
          position="150 -100 0"
          scale="100 100 100"
          rotation="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 60000; easing: linear"
        >
        </a-entity>
      </a-entity>
    </template>

    <template id="scene2">
      <a-entity>
        <a-sky color="lightblue"></a-sky>

        <a-entity
          class="cloud clickable red-cloud"
          geometry="primitive: sphere; radius: 0.8"
          material="color: red"
          position="0 2 -10"
        >
          <a-text
            value="Click me"
            align="center"
            position="0 1 0"
            visible="false"
          ></a-text>
        </a-entity>

        <!-- Animated Ground -->
        <a-entity
          class="dynamic"
          geometry="primitive: plane; width: 50; height: 50"
          material="color: green"
          position="0 -50 0"
          rotation="-90 0 0"
          animation="property: rotation; to: -90 360 0; loop: true; dur: 30000; easing: linear"
        ></a-entity>
      </a-entity>
    </template>

    <template id="scene3">
      <a-entity>
        <a-sky color="#87ceeb"></a-sky>

        <a-entity
          geometry="primitive: box"
          material="color: blue"
          position="-3 2 -8"
          animation="property: position; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true; to: -3 2.5 -8"
        ></a-entity>
        <a-entity
          class="cloud clickable red-cloud"
          geometry="primitive: sphere; radius: 0.8"
          material="color: red"
          position="2 3 -10"
        >
          <a-text
            value="Click me"
            align="center"
            position="0 1 0"
            visible="false"
          ></a-text>
        </a-entity>

        <!-- Animated Ground -->
        <a-entity
          class="dynamic"
          geometry="primitive: plane; width: 50; height: 50"
          material="color: green"
          position="0 -50 0"
          rotation="-90 0 0"
          animation="property: rotation; to: -90 360 0; loop: true; dur: 30000; easing: linear"
        >
        </a-entity>
      </a-entity>

      <!-- Arboles -->

      <a-entity
        gltf-model="#samuuModel"
        position="3 2 -8"
        scale="1 1 1"
        rotation="0 0 0"
      >
      </a-entity>
    </template>

    <!-- Reinsert the script to handle scene switching and cloud enhancement -->
    <script>
      // Índice de la escena actualmente cargada (1, 2 o 3)
      let currentSceneIndex = 1;

      /**
       * fadeInOverlay
       * - Anima la superposición negra (`#fadeOverlay`) para hacer un fade-in
       *   (opacidad 0 -> 1) usando el componente `animation` de A-Frame.
       * - Devuelve una Promise que se resuelve después de la duración de la animación
       *   (500 ms). Útil para encadenar transiciones de escena de forma asincrónica.
       */
      function fadeInOverlay() {
        const overlay = document.querySelector("#fadeOverlay");
        // Coloca una animación que sube la opacidad de 0 a 1 en 500ms
        overlay.setAttribute(
          "animation",
          "property: material.opacity; from: 0; to: 1; dur: 500"
        );
        // Retorna una promise que se resuelve cuando termina la animación
        return new Promise((res) => setTimeout(res, 500));
      }

      /**
       * fadeOutOverlay
       * - El inverso de fadeInOverlay: anima la opacidad de 1 -> 0.
       * - También devuelve una Promise que se resuelve tras 500 ms.
       */
      function fadeOutOverlay() {
        const overlay = document.querySelector("#fadeOverlay");
        // Coloca una animación que baja la opacidad de 1 a 0 en 500ms
        overlay.setAttribute(
          "animation",
          "property: material.opacity; from: 1; to: 0; dur: 500"
        );
        return new Promise((res) => setTimeout(res, 500));
      }

      /**
       * detachCloudHandlers
       * - Clona cada elemento con clase `.cloud` y reemplaza el original por el clon.
       * - Esto elimina (efectivamente) todos los listeners añadidos por `addEventListener`
       *   en el elemento original, ya que el clon no tiene listeners.
       * - Se usa antes de remover/recargar la escena para evitar handlers duplicados
       *   o fugas de memoria cuando se vuelvan a `attachCloudHandlers`.
       */
      function detachCloudHandlers() {
        document.querySelectorAll(".cloud").forEach((cloud) => {
          const clone = cloud.cloneNode(true);
          cloud.parentNode.replaceChild(clone, cloud);
        });
      }

      /**
       * loadScene
       * - Carga la plantilla `#scene{index}` dentro del `<a-scene>` principal.
       * - Flujo:
       *    1. fadeInOverlay() para ocultar la transición.
       *    2. actualiza `currentSceneIndex`.
       *    3. llama a detachCloudHandlers() para limpiar listeners antiguos.
       *    4. borra todos los elementos con la clase `.dynamic` (escena previa).
       *    5. clona el template correspondiente y marca sus nodos como `.dynamic`.
       *    6. adjunta los handlers a las nubes nuevas con attachCloudHandlers().
       *    7. fadeOutOverlay() para mostrar la nueva escena.
       * - Parámetros:
       *    - index: número de la escena a cargar (1, 2 o 3).
       */
      async function loadScene(index) {
        await fadeInOverlay();
        currentSceneIndex = index;
        const scene = document.querySelector("a-scene");
        // Quita event listeners previos en las nubes
        detachCloudHandlers();
        // Remueve entidades dinámicas que pertenecen a la escena previa
        const oldSceneEntities = scene.querySelectorAll(".dynamic");
        oldSceneEntities.forEach((el) => el.remove());
        // Clona el contenido del template correspondiente
        const template = document.querySelector(`#scene${index}`);
        const clone = template.content.cloneNode(true);
        // Marca todos los nodos del template como 'dynamic' para poder limpiarlos luego
        clone
          .querySelectorAll("*")
          .forEach((el) => el.classList.add("dynamic"));
        scene.appendChild(clone);
        // Añade los listeners (mouseenter/mouseleave/click) a las nubes de la nueva escena
        attachCloudHandlers();
        await fadeOutOverlay();
      }

      /**
       * showClickText / hideClickText
       * - Muestran u ocultan el texto hijo (`a-text`) dentro de una nube.
       * - Reciben `entity`, que es el elemento `.cloud` (o cualquier contenedor que tenga
       *   un `a-text` como hijo). No lanzan error si no existe el `a-text`.
       */
      function showClickText(entity) {
        const text = entity.querySelector("a-text");
        if (text) text.setAttribute("visible", "true");
      }

      function hideClickText(entity) {
        const text = entity.querySelector("a-text");
        if (text) text.setAttribute("visible", "false");
      }

      /**
       * enhanceCloud
       * - Añade interactividad a un nodo `.cloud`:
       *    - mouseenter: cambia color (más oscuro para nubes rojas) y muestra texto.
       *    - mouseleave: restaura el color original y oculta el texto.
       *    - click: si la nube roja tiene un id especial (redCloud1/2/3) llama a loadScene
       *             con la escena correspondiente; si no, teletransporta la cámara
       *             al punto de posición de la nube (ajustando la altura).
       * - Parámetro:
       *    - cloud: elemento DOM que representa la nube.
       */
      function enhanceCloud(cloud) {
        cloud.addEventListener("mouseenter", () => {
          const isRed = cloud.classList.contains("red-cloud");
          // Cambia color según si es nube roja o no
          cloud.setAttribute("material", "color", isRed ? "darkred" : "gray");
          showClickText(cloud);
        });
        cloud.addEventListener("mouseleave", () => {
          const isRed = cloud.classList.contains("red-cloud");
          cloud.setAttribute("material", "color", isRed ? "red" : "white");
          hideClickText(cloud);
        });

        cloud.addEventListener("click", () => {
          // Si la nube es una de las nubes rojas especiales, carga la escena asociada
          if (cloud.id === "redCloud1") loadScene(1);
          else if (cloud.id === "redCloud2") loadScene(2);
          else if (cloud.id === "redCloud3") loadScene(3);
          else {
            // Si no es una nube roja, teletransporta el `#cameraRig` a la posición de la nube
            // Ajusta la altura sumando 1.6 para mantener la altura del usuario/cámara
            const pos = cloud.getAttribute("position");
            document
              .querySelector("#cameraRig")
              .setAttribute(
                "position",
                `${pos.x} ${parseFloat(pos.y) + 1.6} ${pos.z}`
              );
          }
        });
      }

      /**
       * attachCloudHandlers
       * - Recorre todas las nubes del documento y aplica `enhanceCloud` a cada una.
       * - Debe llamarse después de insertar elementos dinámicos en la escena.
       */
      function attachCloudHandlers() {
        document.querySelectorAll(".cloud").forEach(enhanceCloud);
      }

      // Cuando la página termina de cargar, attachCloudHandlers enlaza la interactividad
      // y se carga la escena inicial (1).
      window.addEventListener("load", () => {
        attachCloudHandlers();
        loadScene(1);
      });
    </script>
  </body>
</html>
