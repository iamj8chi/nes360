<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A-Frame Forest Demo</title>
    <script src="dist/aframe.min.js"></script>
    <script src="dist/aframe-extras.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .hint {
        position: absolute;
        left: 8px;
        top: 8px;
        color: white;
        font-family: sans-serif;
        background: rgba(0, 0, 0, 0.4);
        padding: 6px 8px;
        border-radius: 4px;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="hint">
      WASD / arrow keys to move, mouse to look. Explore the forest!
    </div>

    <a-scene background="color: #87ceeb">
      <a-assets>
        <!-- Model assets -->
        <a-asset-item
          id="flamingoModel"
          src="assets/flamengo.glb"
        ></a-asset-item>
        <a-asset-item id="samuuModel" src="assets/samuu.glb"></a-asset-item>
      </a-assets>

      <!-- Sky -->
      <a-sky color="#87ceeb"></a-sky>

      <!-- Ocean using a-ocean component -->
      <a-ocean
        width="500"
        depth="500"
        density="40"
        opacity="0.9"
        position="30 -0.5 -10"
      ></a-ocean>

      <!-- Ground (slightly raised) -->
      <a-entity
        geometry="primitive: circle; radius: 25; segments: 64"
        material="color: #3cb371"
        rotation="-90 0 0"
        position="0 0.01 0"
      ></a-entity>

      <!-- Camera rig with WASD controls -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-entity
          camera
          look-controls
          wasd-controls="acceleration: 20"
        ></a-entity>
      </a-entity>

      <!-- Trees replaced by samuu GLTF models (placeholders) -->
      <a-entity id="trees">
        <a-entity
          gltf-model="#samuuModel"
          position="-4 0 -4"
          scale="3 3 3"
          data-collider="true"
          data-collider-radius="1.6"
        ></a-entity>
        <a-entity
          gltf-model="#samuuModel"
          position="3 0 -6"
          scale="2 2 2"
          data-collider="true"
          data-collider-radius="1.6"
        ></a-entity>
        <a-entity
          gltf-model="#samuuModel"
          position="6 0 4"
          scale="3 3 3"
          data-collider="true"
          data-collider-radius="1.6"
        ></a-entity>
        <a-entity
          gltf-model="#samuuModel"
          position="-6 0 6"
          scale="2 2 2"
          data-collider="true"
          data-collider-radius="1.6"
        ></a-entity>
        <a-entity
          gltf-model="#samuuModel"
          position="-10 0 0"
          scale="3 3 3"
          data-collider="true"
          data-collider-radius="1.6"
        ></a-entity>
      </a-entity>

      <!-- Animals replaced by flamingo GLTF models (animated with animal-behavior) -->
      <a-entity id="animals">
        <a-entity
          gltf-model="#flamingoModel"
          position="0 5 0"
          scale="2 2 2"
          animal-behavior="speed: 0.2; radius: 2; yawOffset: 0"
          animation-mixer
        ></a-entity>
        <a-entity
          gltf-model="#flamingoModel"
          position="0 5 0"
          scale="2 2 2"
          animal-behavior="speed: 0.2; radius: 5; yawOffset: 0"
          animation-mixer
        ></a-entity>
        <a-entity
          gltf-model="#flamingoModel"
          position="0 5 0"
          scale="2 2 2"
          animal-behavior="speed: 0.2; radius: 8; yawOffset: 0"
          animation-mixer
        ></a-entity>
      </a-entity>

      <!-- Invisible plane for collisions (optional) moved slightly up to match ground -->
      <a-entity
        id="floor"
        geometry="primitive: plane; width: 100; height: 100"
        rotation="-90 0 0"
        position="0 0.01 0"
        visible="false"
      ></a-entity>

      <script>
        // Simple animal movement using circular paths
        AFRAME.registerComponent("animal-behavior", {
          schema: {
            speed: { type: "number", default: 0.5 },
            radius: { type: "number", default: 2 },
            yawOffset: { type: "number", default: 0 },
          },
          init: function () {
            this.startTime = Date.now();
            this.center = this.el.object3D.position.clone();
          },
          tick: function (t, dt) {
            const elapsed = (Date.now() - this.startTime) / 1000;
            const r = this.data.radius;
            const speed = this.data.speed;
            // circular orbit around initial center
            const ang = elapsed * speed;
            const nx = this.center.x + Math.cos(ang) * r;
            const nz = this.center.z + Math.sin(ang) * r;
            const curY = this.el.getAttribute("position")?.y ?? this.center.y;
            this.el.setAttribute("position", `${nx} ${curY} ${nz}`);

            // compute tangent direction and add yaw offset
            const tx = -Math.sin(ang) * r;
            const tz = Math.cos(ang) * r;
            // angle in radians where 0 points along +X; convert to degrees and set rotation around Y
            const yaw =
              Math.atan2(tz, tx) * (180 / Math.PI) + this.data.yawOffset;
            this.el.setAttribute("rotation", `0 ${yaw} 0`);
          },
        });

        // Prevent cameraRig from falling below ground if physics not used
        AFRAME.registerComponent("stay-grounded", {
          tick: function () {
            const rig = document.querySelector("#cameraRig");
            if (!rig) return;
            const p = rig.getAttribute("position");
            if (p.y < 1.6) rig.setAttribute("position", `${p.x} 1.6 ${p.z}`);
          },
        });
        document.querySelector("#cameraRig").setAttribute("stay-grounded", "");

        // Simple collider-check: prevents cameraRig from passing through entities marked with data-collider
        AFRAME.registerComponent("collider-check", {
          schema: {
            padding: { type: "number", default: 0.4 },
          },
          init: function () {
            this.rig = document.querySelector("#cameraRig");
            this.colliders = Array.from(
              document.querySelectorAll('[data-collider="true"]')
            );
          },
          tick: function () {
            if (!this.rig) return;
            const rigPos = this.rig.getAttribute("position");
            let x = rigPos.x,
              y = rigPos.y,
              z = rigPos.z;

            // check tree colliders (spherical approximation)
            for (const el of this.colliders) {
              const radius =
                parseFloat(el.getAttribute("data-collider-radius")) || 1.2;
              const p = el.getAttribute("position");
              const dx = x - p.x;
              const dz = z - p.z;
              const dist = Math.sqrt(dx * dx + dz * dz);
              const min = radius + this.data.padding;
              if (dist < min && dist > 0.0001) {
                // push rig out along the vector between collider center and rig
                const nx = (dx / dist) * min + p.x;
                const nz = (dz / dist) * min + p.z;
                this.rig.setAttribute("position", `${nx} ${y} ${nz}`);
                x = nx;
                z = nz;
              }
            }
          },
        });
        // enable collider-check on the scene so it runs each tick
        document.querySelector("a-scene").setAttribute("collider-check", "");

        // Add random trees on page load
        window.addEventListener("load", () => {
          const treeContainer = document.querySelector("#trees");
          const numTrees = 15; // number of additional random trees
          const minDist = 5; // minimum distance between trees
          const maxRadius = 40; // maximum distance from center

          // Helper to get random position with minimum distance from existing trees
          function getValidPosition() {
            for (let attempts = 0; attempts < 50; attempts++) {
              const angle = Math.random() * Math.PI * 2;
              const radius = Math.random() * maxRadius;
              const x = Math.cos(angle) * radius;
              const z = Math.sin(angle) * radius;

              // Check distance from existing trees
              let valid = true;
              const existingTrees = treeContainer.children;
              for (let tree of existingTrees) {
                const pos = tree.getAttribute("position");
                const dx = x - pos.x;
                const dz = z - pos.z;
                const dist = Math.sqrt(dx * dx + dz * dz);
                if (dist < minDist) {
                  valid = false;
                  break;
                }
              }
              if (valid) return { x, z };
            }
            return null; // no valid position found
          }

          // Add random trees
          for (let i = 0; i < numTrees; i++) {
            const pos = getValidPosition();
            if (pos) {
              const scale = 2 + Math.random(); // random scale between 2-3
              const tree = document.createElement("a-entity");
              tree.setAttribute("gltf-model", "#samuuModel");
              tree.setAttribute("position", `${pos.x} 0 ${pos.z}`);
              tree.setAttribute("scale", `${scale} ${scale} ${scale}`);
              tree.setAttribute("data-collider", "true");
              tree.setAttribute("data-collider-radius", "1.6");
              treeContainer.appendChild(tree);
            }
          }
        });
      </script>
    </a-scene>
  </body>
</html>
